{% extends "base.html" %}
{% block title %}Products — ShopAPI Demo{% endblock %}

{% block content %}

<div class="mb-6">
  <h1 class="text-3xl font-bold text-slate-800">Browse Products</h1>
  <p class="text-slate-500 mt-1">{{ total }} product{% if total != 1 %}s{% endif %} available</p>
</div>

<form method="GET" action="/web/products" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 mb-8">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">

    <div class="lg:col-span-2">
      <label for="q" class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">Search</label>
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input type="text" id="q" name="q" value="{{ search_query }}" placeholder="Search products…" class="w-full pl-9 pr-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition">
      </div>
    </div>

    <div>
      <label for="category_id" class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">Category</label>
      <select id="category_id" name="category_id" onchange="updateSubcategories()" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition bg-white">
        <option value="">All Categories</option>
        {% for cat in categories if not cat.parent_id %}
        <option value="{{ cat.id }}"{% if current_category == cat.id %} selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="subcategory_id" class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">Subcategory</label>
      <select id="subcategory_id" name="subcategory_id" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition bg-white" {% if not current_subcategory %}disabled{% endif %}>
        <option value="">Any Subcategory</option>
        <!-- Populated via JS -->
      </select>
    </div>

    <div>
      <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">Min Rating</label>
      <div class="flex items-center gap-1 ratings-filter bg-white border border-slate-200 px-2 py-1.5 rounded-xl text-slate-400">
        <input type="hidden" name="min_rating" id="min_rating" value="{{ min_rating or '' }}">
        {% for i in range(1, 6) %}
        <button type="button" data-rating="{{ i }}" class="star-btn hover:text-amber-400 transition {% if min_rating and min_rating|float >= i %}text-amber-400{% endif %}">
          <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
        </button>
        {% endfor %}
      </div>
    </div>

    <div>
      <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">Price Range</label>
      <div class="flex gap-2">
        <input type="number" name="min_price" value="{{ min_price or '' }}" placeholder="Min" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
        <input type="number" name="max_price" value="{{ max_price or '' }}" placeholder="Max" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
        <input type="checkbox" name="in_stock" value="1"{% if in_stock %} checked{% endif %} class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-400">
        In stock only
      </label>
      <div class="flex gap-2">
        <button type="submit" class="btn-primary flex-1 text-white text-sm font-semibold py-2.5 px-4 rounded-xl shadow-sm">Search</button>
        <a href="/web/products" class="flex items-center justify-center px-3 py-2.5 rounded-xl border border-slate-200 text-slate-400 hover:text-slate-600 hover:border-slate-300 transition" title="Clear filters">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </a>
      </div>
    </div>

  </div>
</form>

{% if search_query or current_category or min_price or max_price %}
<div class="flex items-center gap-2 mb-4 text-sm text-slate-500">
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
  Showing <strong>{{ products|length }}</strong> of <strong>{{ total }}</strong> results{% if search_query %} for "<em>{{ search_query }}</em>"{% endif %}
</div>
{% endif %}

{% if products %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
  {% for product in products %}
  <div class="card-hover bg-white rounded-2xl border border-slate-200 overflow-hidden flex flex-col">

    <a href="/web/products/{{ product.id }}" class="block">
      <div class="h-48 flex flex-col items-center justify-center relative overflow-hidden card-bg-{{ loop.index0 % 5 }}">
        <svg class="w-16 h-16 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
        <span class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-400 bg-white/70 px-1.5 py-0.5 rounded">{{ product.sku }}</span>
        {% if product.stock == 0 %}<span class="absolute top-2 left-2 text-[10px] font-semibold bg-red-100 text-red-600 px-2 py-0.5 rounded-full">Out of Stock</span>
        {% elif product.stock <= 5 %}<span class="absolute top-2 left-2 text-[10px] font-semibold bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Low Stock</span>
        {% endif %}
      </div>
    </a>

    <div class="p-4 flex flex-col flex-1">
      <a href="/web/products/{{ product.id }}" class="font-semibold text-slate-800 hover:text-indigo-600 transition-colors line-clamp-2 mb-1 leading-snug">{{ product.name }}</a>

      <div class="flex items-center justify-between mt-auto pt-3">
        <span class="text-xl font-bold text-indigo-600">${{ "%.2f"|format(product.price) }}</span>
        <span class="text-xs font-medium {% if product.stock > 5 %}text-emerald-600{% elif product.stock > 0 %}text-amber-600{% else %}text-red-500{% endif %}">
          {% if product.stock == 0 %}Unavailable{% elif product.stock <= 5 %}{{ product.stock }} left{% else %}{{ product.stock }} in stock{% endif %}
        </span>
      </div>

      {% if product.stock > 0 %}
      <form method="POST" action="/web/cart/add/{{ product.id }}" class="mt-3">
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="w-full btn-primary text-white text-sm font-semibold py-2 rounded-xl shadow-sm flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
          Add to Cart
        </button>
      </form>
      {% else %}
      <button disabled class="w-full mt-3 bg-slate-100 text-slate-400 text-sm font-semibold py-2 rounded-xl cursor-not-allowed">Out of Stock</button>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

{% if pages > 1 %}
<div class="flex items-center justify-center gap-2">
  {% if page > 1 %}<a href="?page={{ page - 1 }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_category %}&category_id={{ current_category }}{% endif %}{% if in_stock %}&in_stock=1{% endif %}" class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Prev</a>{% endif %}
  {% for p in range(1, pages + 1) %}
    {% if p == page %}<span class="px-4 py-2 rounded-xl text-sm font-semibold text-white shadow-sm" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">{{ p }}</span>
    {% elif p == 1 or p == pages or (p >= page - 1 and p <= page + 1) %}<a href="?page={{ p }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_category %}&category_id={{ current_category }}{% endif %}{% if in_stock %}&in_stock=1{% endif %}" class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-50 transition">{{ p }}</a>
    {% elif p == page - 2 or p == page + 2 %}<span class="px-2 text-slate-400">…</span>
    {% endif %}
  {% endfor %}
  {% if page < pages %}<a href="?page={{ page + 1 }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_category %}&category_id={{ current_category }}{% endif %}{% if in_stock %}&in_stock=1{% endif %}" class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-1">Next<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></a>{% endif %}
</div>
{% endif %}

{% else %}
<div class="bg-white rounded-2xl border border-slate-200 p-16 text-center">
  <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style="background:linear-gradient(135deg,#eef2ff,#c7d2fe)">
    <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4"/></svg>
  </div>
  <h2 class="text-lg font-semibold text-slate-700 mb-2">No products found</h2>
  <p class="text-sm text-slate-400 mb-6">Try adjusting your search or filters.</p>
  <a href="/web/products" class="btn-primary inline-flex items-center gap-2 text-white text-sm font-semibold px-5 py-2.5 rounded-xl shadow-sm">Clear Filters</a>
</div>
{% endif %}

<script>
// Category Data for Subcategory Dropdown
const categories = [
  /* {% for cat in categories %} */
  {
    id: parseInt("{{ cat.id }}"),
    name: "{{ cat.name|escape }}",
    parent_id: parseInt("{{ cat.parent_id if cat.parent_id else '0' }}") || null
  },
  /* {% endfor %} */
];

function updateSubcategories() {
  const parentId = document.getElementById('category_id').value;
  const subSelect = document.getElementById('subcategory_id');
  const currentSub = "{{ current_subcategory or '' }}";

  // Clear existing
  subSelect.innerHTML = '<option value="">Any Subcategory</option>';
  
  if (!parentId) {
    subSelect.disabled = true;
    return;
  }

  const subs = categories.filter(c => c.parent_id == parentId);
  if (subs.length === 0) {
    subSelect.disabled = true;
  } else {
    subSelect.disabled = false;
    subs.forEach(sub => {
      const isSelected = sub.id == currentSub ? 'selected' : '';
      subSelect.innerHTML += `<option value="${sub.id}" ${isSelected}>${sub.name}</option>`;
    });
  }
}

// Rating filter logic
document.querySelectorAll('.star-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const rating = btn.dataset.rating;
    const input = document.getElementById('min_rating');
    const allStars = document.querySelectorAll('.star-btn');
    
    if (input.value === rating) {
      // Toggle off
      input.value = '';
      allStars.forEach(s => s.classList.remove('text-amber-400'));
    } else {
      // Set rating
      input.value = rating;
      allStars.forEach(s => {
        if (parseInt(s.dataset.rating) <= parseInt(rating)) {
          s.classList.add('text-amber-400');
        } else {
          s.classList.remove('text-amber-400');
        }
      });
    }
  });
});

// Run on load to set initial state
updateSubcategories();
</script>

{% endblock %}
